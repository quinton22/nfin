#!/usr/bin/env bash

NFIN_HOME="$HOME/.nfin"
NFIN_ETC_DIR="$NFIN_HOME/etc"
NFIN_SETTINGS_FILE="$NFIN_ETC_DIR/config.json"
NFIN_TMP_DIR="$NFIN_HOME/tmp"
NFIN_VAR_DIR="$NFIN_HOME/var"

if [[ -d "$NFIN_HOME" ]]; then
  echo 'nFin is already installed. To update, run `nfin update`'
  echo 'Would like to proceed with a clean install and remove your current ~/.nfin directory? (y/N)'
  read new_install
  case $new_install in
    y|Y|yes|Yes)
      rm -rf "$HOME/.nfin"
      ;;
    n|N|no|No|"")
      exit 1
      ;;
    *)
      echo "'$new_install' is not a valid response. Please choose (y/N)."
      exit 1
      ;;
  esac
fi

if ! command -v curl > /dev/null; then
  echo "Please install curl"
  exit 1
fi

if ! command -v jq > /dev/null; then
  echo "Please install jq. On mac: brew install jq"
  exit 1
fi

mkdir "$NFIN_HOME"
mkdir "$NFIN_ETC_DIR"
mkdir "$NFIN_VAR_DIR"
mkdir "$NFIN_TMP_DIR"

curl 'https://github.com/quinton22/nfin/archive/refs/heads/main.zip' -sL -o "$NFIN_TMP_DIR/nfin.zip"

if [[ ! -f "$NFIN_TMP_DIR/nfin.zip" ]]; then
  echo "Failed to download, please try again."
  rm -rf "$NFIN_HOME"
  exit 1;
fi

unzip -qo "$NFIN_TMP_DIR/nfin.zip" -d "$NFIN_TMP_DIR"
rm -rf "$NFIN_TMP_DIR/nfin.zip"

for f in $NFIN_TMP_DIR/*; do
  [[ -d "$f/bin" ]] && \
  cp -R "$f/bin" "$NFIN_HOME" 2> /dev/null
   [[ -f "$f/config.template" ]] && \
  cp "$f/config.template" "$NFIN_HOME" 2> /dev/null
done

rm -rf "$NFIN_TMP_DIR/*"
cp "$NFIN_HOME/config.template" "$NFIN_SETTINGS_FILE"
rm -rf "$NFIN_HOME/config.template"

function add_to_rc_file {
  if [[ -s "$1" ]]; then

    grep -q '^[ ]*export NFIN_HOME="$HOME/.nfin"' $1 && \
    grep -q "^[ ]*\[\[ -s \"\$NFIN_HOME/bin/internal/$2\" \]\] && source \"\$NFIN_HOME/bin/internal/$2\"" $1 || \
    cat << EOF >> "$1"

export NFIN_HOME="\$HOME/.nfin"
[[ -s "\$NFIN_HOME/bin/internal/$2" ]] && source "\$NFIN_HOME/bin/internal/$2"
EOF

    echo "Yay! nFin successfully installed! You can run 'source $1' to use it now, or restart your terminal"
  else
    return 1
  fi
}

add_to_rc_file "${ZDOTDIR:-$HOME}/.zshrc" "init-zsh" || \
add_to_rc_file "$HOME/.bashrc" "init-sh" || \
{ touch "$HOME/.bash_profile"; add_to_rc_file "$HOME/.bash_profile" "init"; }

# use https://raw.githubusercontent.com/quinton22/nfin/main/bin/internal/install
