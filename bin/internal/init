#!/usr/bin/env bash

local shell_name=$(echo "$SHELL" | grep -oE '[^/]+$')
: ${shell_name:='bash'}

export NFIN_DIR=$NFIN_HOME/bin
export PATH=$PATH:$NFIN_DIR

source "$NFIN_DIR/internal/notify"

function nfin_precmd() {
  local last_return_code=$?
  [[ -z $nfin_start_time ]] && return 0

  handle_notify $nfin_start_time $(date +%s) $last_return_code
  nfin_start_time=
}
 

function nfin_preexec() {
  nfin_start_time=$(date +%s)
  NFIN_USER_COMMAND=$1

  # eval "$PROMPT_COMMAND"
}


if [[ $shell_name == zsh ]]; then
  if [[ ! "$precmd_functions[@]" =~ 'nfin_precmd' ]]; then
    precmd_functions+=(nfin_precmd)
  fi

  if [[ ! "$preexec_functions[@]" =~ 'nfin_preexec' ]]; then
    preexec_functions+=(nfin_preexec)
  fi
fi

PROMPT_COMMAND="start_time=$SECONDS; echo \"|$BASH_COMMAND|\"; end_time=$SECONDS;
elapsed_time=$((end_time - start_time)); echo $elapsed_time"

